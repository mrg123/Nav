document.addEventListener('DOMContentLoaded', () => {
  // Ê∑ªÂä†ÁªìÊûÑÂåñÊï∞ÊçÆ
  const structuredData = {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "‰∏™‰∫∫ÁΩëÁ´ôÂØºËà™Á≥ªÁªü",
    "description": "Êî∂ËóèÊï¥ÁêÜÂ∏∏Áî®Êñ∞ÈóªÂ™í‰Ωì„ÄÅÂ≠¶‰π†ËµÑÊ∫êÂíåË¥¢ÁªèËµÑËÆØÁΩëÁ´ô",
    "applicationCategory": "UtilityApplication",
    "operatingSystem": "Web Browser",
    "offers": {
      "@type": "Offer",
      "price": "0",
      "priceCurrency": "USD"
    },
    "featureList": [
      "Êñ∞ÈóªÂ™í‰ΩìÂØºËà™",
      "Â≠¶‰π†ËµÑÊ∫êÂØºËà™",
      "Ë¥¢ÁªèËµÑËÆØÂØºËà™",
      "ÁΩëÁ´ôÊêúÁ¥¢ÂäüËÉΩ",
      "Êï∞ÊçÆÂØºÂÖ•ÂØºÂá∫"
    ]
  };

  // Â∞ÜÁªìÊûÑÂåñÊï∞ÊçÆÊ∑ªÂä†Âà∞È°µÈù¢
  const script = document.createElement('script');
  script.type = 'application/ld+json';
  script.text = JSON.stringify(structuredData);
  document.head.appendChild(script);

  // ÁΩëÁ´ôÊï∞ÊçÆÂ≠òÂÇ®
  let sitesData = {
    international: [
      { name: 'BBC‰∏≠ÊñáÁΩë', url: 'https://www.bbc.com/zhongwen', description: 'Ëã±ÂõΩÂπøÊí≠ÂÖ¨Âè∏‰∏≠ÊñáÊñ∞Èóª', icon: 'üåê' },
      { name: 'ÂΩ≠ÂçöÁ§æ', url: 'https://www.bloomberg.com/asia', description: 'Ë¥¢Áªè‰∏éÂÖ®ÁêÉÂïÜ‰∏öÊñ∞Èóª', icon: 'üî∂' },
      { name: 'Ë∑ØÈÄèÁ§æ‰∏≠Êñá', url: 'https://cn.reuters.com/', description: 'ÂõΩÈôÖÊñ∞Èóª‰∏éÊó∂‰∫ã', icon: 'üåç' },
      { name: 'Á∫ΩÁ∫¶Êó∂Êä•‰∏≠ÊñáÁΩë', url: 'https://cn.nytimes.com/', description: 'ÁæéÂõΩËßÜËßíÂÖ®ÁêÉÊä•ÈÅì', icon: 'üóΩ' }
    ],
    domestic: [
      { name: 'ËßÇÂØüËÄÖÁΩë', url: 'https://www.guancha.cn/', description: '‰∏≠ÂõΩËßÜËßíÂõΩÈôÖÂàÜÊûê', icon: 'üî≠' },
      { name: 'ÊæéÊπÉÊñ∞Èóª', url: 'https://www.thepaper.cn/', description: 'Êó∂Êîø‰∏éÁ§æ‰ºöÊñ∞Èóª', icon: 'üì±' },
      { name: '‰∫∫Ê∞ëÊó•Êä•', url: 'http://www.people.com.cn/', description: 'ÂÆòÊñπÊùÉÂ®Å‰ø°ÊÅØ', icon: 'üèõÔ∏è' }
    ],
    finance: [
      { name: 'Ë¥¢Êñ∞ÁΩë', url: 'https://www.caixin.com/', description: 'Ê∑±Â∫¶Ë¥¢ÁªèÊä•ÈÅì', icon: 'üíπ' },
      { name: 'ÂçéÂ∞îË°óÊó•Êä•‰∏≠ÊñáÁΩë', url: 'https://cn.wsj.com/', description: 'ÂÖ®ÁêÉÈáëËûçÂ∏ÇÂú∫Âä®ÊÄÅ', icon: 'üìà' },
      { name: 'ÁïåÈù¢Êñ∞Èóª', url: 'https://www.jiemian.com/', description: 'Ë¥¢ÁªèÂïÜ‰∏öËµÑËÆØ', icon: 'üí∞' }
    ],
    learning: [
      { name: 'Coursera', url: 'https://www.coursera.org/', description: 'ÂÖ®ÁêÉÂêçÊ†°Âú®Á∫øËØæÁ®ã', icon: 'üéì' },
      { name: '‰∏≠ÂõΩÂ§ßÂ≠¶MOOC', url: 'https://www.icourse163.org/', description: 'ÂõΩÂÜÖÈ´òÊ†°Á≤æÂìÅËØæÁ®ã', icon: 'üß†' },
      { name: 'Áü•ÁΩë', url: 'https://www.cnki.net/', description: '‰∏≠ÂõΩÂ≠¶ÊúØÊñáÁåÆËµÑÊ∫ê', icon: 'üìë' },
      { name: 'Google Scholar', url: 'https://scholar.google.com/', description: 'Â≠¶ÊúØËÆ∫ÊñáÊêúÁ¥¢', icon: 'üî¨' }
    ]
  };
  
  // ‰ªéÊú¨Âú∞Â≠òÂÇ®Âä†ËΩΩÊï∞ÊçÆ
  const loadData = () => {
    const savedData = localStorage.getItem('navSitesData');
    if (savedData) {
      sitesData = JSON.parse(savedData);
      renderSites();
    }
  };
  
  // ‰øùÂ≠òÊï∞ÊçÆÂà∞Êú¨Âú∞Â≠òÂÇ®
  const saveData = () => {
    localStorage.setItem('navSitesData', JSON.stringify(sitesData));
  };
  
  // Ê∏≤ÊüìÊâÄÊúâÁΩëÁ´ô
  const renderSites = () => {
    // Ê∏≤ÊüìÂø´ÈÄüËÆøÈóÆÂå∫
    const quickCards = document.querySelector('.quick-cards');
    quickCards.innerHTML = '';
    
    // Êî∂ÈõÜÊâÄÊúâÁΩëÁ´ôÂπ∂Êåâ‰ΩøÁî®È¢ëÁéáÊéíÂ∫èÔºàËøôÈáåÊ®°ÊãüÔºâ
    const allSites = [];
    Object.values(sitesData).forEach(category => {
      category.forEach(site => {
        allSites.push(site);
      });
    });
    
    // ÈÄâÂèñÂâç5‰∏™‰Ωú‰∏∫Âø´ÈÄüËÆøÈóÆ
    allSites.slice(0, 5).forEach(site => {
      const quickCard = document.createElement('a');
      quickCard.href = site.url;
      quickCard.className = 'quick-card';
      quickCard.target = '_blank';
      quickCard.innerHTML = `
        <div class="card-icon">${site.icon}</div>
        <div class="card-name">${site.name}</div>
      `;
      quickCards.appendChild(quickCard);
    });
    
    // Ê∏≤ÊüìÂàÜÁ±ªÂå∫Âüü
    const categories = {
      international: document.querySelector('.category:nth-child(1) .sites-grid'),
      domestic: document.querySelector('.category:nth-child(2) .sites-grid'),
      finance: document.querySelector('.category:nth-child(3) .sites-grid'),
      learning: document.querySelector('.category:nth-child(4) .sites-grid')
    };
    
    Object.keys(categories).forEach(key => {
      categories[key].innerHTML = '';
      sitesData[key].forEach(site => {
        const siteCard = document.createElement('a');
        siteCard.href = site.url;
        siteCard.className = 'site-card';
        siteCard.target = '_blank';
        siteCard.innerHTML = `
          <div class="site-icon">${site.icon}</div>
          <div class="site-info">
            <h3>${site.name}</h3>
            <p>${site.description}</p>
          </div>
          <div class="delete-btn" aria-label="Âà†Èô§ÁΩëÁ´ô">‚úó</div>
        `;
        
        // Ê∑ªÂä†Âà†Èô§ÊåâÈíÆ‰∫ã‰ª∂
        const deleteBtn = siteCard.querySelector('.delete-btn');
        deleteBtn.addEventListener('click', (e) => {
          e.preventDefault(); // ÈòªÊ≠¢ÈìæÊé•Ë∑≥ËΩ¨
          e.stopPropagation(); // ÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°
          
          // Ê∑ªÂä†Âà†Èô§Á°ÆËÆ§Âä®Áîª
          siteCard.style.animation = 'fadeOut 0.3s ease forwards';
          
          // Âª∂ËøüÂà†Èô§ÔºåÁ≠âÂæÖÂä®ÁîªÂÆåÊàê
          setTimeout(() => {
            // ‰ªéÊï∞ÊçÆ‰∏≠Âà†Èô§
            const index = sitesData[key].findIndex(s => s.url === site.url);
            if (index !== -1) {
              sitesData[key].splice(index, 1);
              saveData();
              renderSites();
              enableCardTiltEffect();
            }
          }, 300);
        });
        
        categories[key].appendChild(siteCard);
      });
    });

    // ‰∏∫ÊØè‰∏™ÁΩëÁ´ôÊ∑ªÂä†ÁªìÊûÑÂåñÊï∞ÊçÆ
    Object.values(sitesData).forEach(category => {
      category.forEach(site => {
        const siteStructuredData = {
          "@context": "https://schema.org",
          "@type": "WebSite",
          "name": site.name,
          "url": site.url,
          "description": site.description
        };
        
        const script = document.createElement('script');
        script.type = 'application/ld+json';
        script.text = JSON.stringify(siteStructuredData);
        document.head.appendChild(script);
      });
    });
  };
  
  // ÂàÜÁ±ªÊäòÂè†ÂäüËÉΩ
  const categoryToggles = document.querySelectorAll('.category-toggle');
  categoryToggles.forEach(toggle => {
    toggle.addEventListener('click', () => {
      const category = toggle.closest('.category');
      const sitesGrid = category.querySelector('.sites-grid');
      
      if (sitesGrid.style.display === 'none') {
        sitesGrid.style.display = 'grid';
        toggle.textContent = '-';
        sitesGrid.style.animation = 'fadeIn 0.5s ease forwards';
      } else {
        sitesGrid.style.display = 'none';
        toggle.textContent = '+';
      }
    });
  });
  
  // ÊêúÁ¥¢ÂäüËÉΩ
  const searchInput = document.querySelector('.search-input');
  searchInput.addEventListener('input', (e) => {
    const searchTerm = e.target.value.toLowerCase();
    const allSiteCards = document.querySelectorAll('.site-card');
    
    allSiteCards.forEach(card => {
      const title = card.querySelector('h3').textContent.toLowerCase();
      const description = card.querySelector('p').textContent.toLowerCase();
      
      if (title.includes(searchTerm) || description.includes(searchTerm)) {
        card.style.display = 'flex';
        // È´ò‰∫ÆÂåπÈÖçÊñáÊú¨ÁöÑÂä®ÁîªÊïàÊûú
        card.style.boxShadow = '0 0 10px rgba(0, 238, 255, 0.5)';
        setTimeout(() => {
          card.style.boxShadow = 'none';
        }, 1000);
      } else {
        card.style.display = 'none';
      }
    });
  });
  
  // ‰∏ªÈ¢òÂàáÊç¢ÂäüËÉΩ
  const themeToggle = document.querySelector('.theme-toggle');
  const loadTheme = () => {
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'light') {
      document.body.classList.add('light-theme');
      themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
    } else {
      document.body.classList.remove('light-theme');
      themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
    }
  };

  themeToggle.addEventListener('click', () => {
    document.body.classList.toggle('light-theme');
    const isLightTheme = document.body.classList.contains('light-theme');
    
    // ‰øùÂ≠ò‰∏ªÈ¢òËÆæÁΩÆ
    localStorage.setItem('theme', isLightTheme ? 'light' : 'dark');
    
    // Êõ¥Êñ∞ÂõæÊ†á
    themeToggle.innerHTML = isLightTheme ? 
      '<i class="fas fa-sun"></i>' : 
      '<i class="fas fa-moon"></i>';
  });
  
  // ÂàùÂßãÂåñÊó∂Âä†ËΩΩ‰øùÂ≠òÁöÑ‰∏ªÈ¢ò
  loadTheme();
  
  // Â¢ûÂº∫Âç°ÁâáÊÇ¨ÂÅúÁâπÊïà
  const enableCardTiltEffect = () => {
    const allCards = document.querySelectorAll('.site-card, .quick-card');
    allCards.forEach(card => {
      card.addEventListener('mousemove', (e) => {
        const rect = card.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        // Â¢ûÂº∫3DÂÄæÊñúÊïàÊûú
        const tiltX = (y / rect.height - 0.5) * 20;
        const tiltY = (x / rect.width - 0.5) * -20;
        
        // Ê∑ªÂä†Áº©ÊîæÊïàÊûú
        const scale = 1.05;
        
        // Ê∑ªÂä†Èò¥ÂΩ±ÊïàÊûú
        const shadowX = (x / rect.width - 0.5) * 20;
        const shadowY = (y / rect.height - 0.5) * 20;
        const shadowBlur = 20;
        
        card.style.transform = `
          perspective(1000px)
          rotateX(${tiltX}deg)
          rotateY(${tiltY}deg)
          scale(${scale})
          translateZ(20px)
        `;
        
        card.style.boxShadow = `
          ${shadowX}px ${shadowY}px ${shadowBlur}px rgba(0, 238, 255, 0.3),
          ${-shadowX}px ${-shadowY}px ${shadowBlur}px rgba(0, 238, 255, 0.2)
        `;
      });
      
      card.addEventListener('mouseleave', () => {
        card.style.transform = '';
        card.style.boxShadow = '';
      });
    });
  };
  
  // Ê®°ÊÄÅÊ°ÜÂäüËÉΩ
  const modal = document.getElementById('add-site-modal');
  const addBtn = document.getElementById('add-site-btn');
  const closeModal = document.querySelector('.close-modal');
  const addSiteForm = document.getElementById('add-site-form');
  
  addBtn.addEventListener('click', () => {
    modal.style.display = 'flex';
  });
  
  closeModal.addEventListener('click', () => {
    modal.style.display = 'none';
  });
  
  window.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.style.display = 'none';
    }
  });
  
  // Ê∑ªÂä†Êñ∞ÁΩëÁ´ô
  addSiteForm.addEventListener('submit', (e) => {
    e.preventDefault();
    
    const name = document.getElementById('site-name').value;
    const url = document.getElementById('site-url').value;
    const description = document.getElementById('site-description').value || 'Êú™Ê∑ªÂä†ÊèèËø∞';
    const category = document.getElementById('site-category').value;
    const icon = document.getElementById('site-icon').value || 'üîó';
    
    const newSite = { name, url, description, icon };
    sitesData[category].push(newSite);
    
    saveData();
    renderSites();
    enableCardTiltEffect();
    
    modal.style.display = 'none';
    addSiteForm.reset();
  });
  
  // ÂØºÂá∫Êï∞ÊçÆ
  document.getElementById('export-data').addEventListener('click', (e) => {
    e.preventDefault();
    const dataStr = JSON.stringify(sitesData);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    
    const exportFileDefaultName = 'my_nav_data.json';
    
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
  });
  
  // ÂØºÂÖ•Êï∞ÊçÆ
  document.getElementById('import-data').addEventListener('click', (e) => {
    e.preventDefault();
    
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    
    input.onchange = (e) => {
      const file = e.target.files[0];
      const reader = new FileReader();
      
      reader.onload = (e) => {
        try {
          const importedData = JSON.parse(e.target.result);
          sitesData = importedData;
          saveData();
          renderSites();
          enableCardTiltEffect();
          alert('Êï∞ÊçÆÂØºÂÖ•ÊàêÂäüÔºÅ');
        } catch (error) {
          alert('ÂØºÂÖ•Â§±Ë¥•ÔºåÊñá‰ª∂Ê†ºÂºèÈîôËØØ');
        }
      };
      
      reader.readAsText(file);
    };
    
    input.click();
  });
  
  // Ê∑ªÂä†Âà†Èô§Âä®Áîª
  const style = document.createElement('style');
  style.textContent = `
    @keyframes fadeOut {
      from {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
      to {
        opacity: 0;
        transform: translateY(20px) scale(0.9);
      }
    }
  `;
  document.head.appendChild(style);
  
  // ÂàùÂßãÂåñ
  loadData();
  enableCardTiltEffect();
}); 